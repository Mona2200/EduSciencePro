@using EduSciencePro.ViewModels.Response
@model PostsAndUserIdViewModel;

@if (Model.Posts == null || Model.Posts.Length == 0)
{
    <p class="text-center mt-5">Публикаций нет</p>
}
else
{
    <div id="posts_div">


        @foreach (var post in Model.Posts)
        {
            <div class="mb-3 mt-5 posts">
                <p class="title">@post.Title</p>
                <p class="color-blue">@post.CreatedDate</p>
                <div class="mt-2 posts_content">@Html.Raw(@post.Content)</div>
                <p>
                    @foreach (var tag in post.Tags)
                    {
                        <span class="bg_blue p-2 m-2 d-inline-block">@tag.Name</span>
                    }
                </p>
                <div class="row align-items-center mt-5">
                    <span class="col-xl-3 col-xxl-2 col-lg-4 col-md-2 col-sm-4 col-sm-4 col-5">
                        <span>@post.Likes.Length</span>
                        @if (Context.User.Identity.IsAuthenticated)
                        {
                            @if (post.Likes.FirstOrDefault(l => l.UserId == Model.UserId) != null)
                            {
                                <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="cursor:pointer;" onclick="like_post('@post.Id', this)">
                                    <path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill="#F8312F" />
                                </svg>
                            }
                            else
                            {
                                <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="cursor:pointer;" onclick="like_post('@post.Id', this)">
                                    <path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill="#CDE7FF" />
                                </svg>
                            }
                        }
                        else
                        {
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill="#CDE7FF" />
                            </svg>
                        }

                    </span>
                    <span class="col-xl-3 col-xxl-2 col-lg-4 col-md-2 col-sm-4 col-sm-4 col-5">
                        <span>@post.Comments.Length</span>
                        <a asp-action="LookingPost" asp-controller="Post" asp-route-postId="@post.Id">
                            <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.3 18.3L16 16H2C1.45 16 0.979333 15.8043 0.588 15.413C0.196 15.021 0 14.55 0 14V2C0 1.45 0.196 0.979 0.588 0.587C0.979333 0.195667 1.45 0 2 0H18C18.55 0 19.021 0.195667 19.413 0.587C19.8043 0.979 20 1.45 20 2V17.575C20 18.025 19.796 18.3373 19.388 18.512C18.9793 18.6873 18.6167 18.6167 18.3 18.3Z" fill="#CDE7FF" />
                            </svg>
                        </a>

                    </span>
                    @if (post.User.Email == Context.User.Identity.Name)
                    {
                        <span style="cursor:pointer;font-size: 25px;" class="col-xl-6 col-xxl-8 col-lg-4 col-md-8 col-sm-4 col-sm-4 col-2 color-blue text-end" onclick="abilityPost(this)">…</span>
                        <div class="div_ability_post d-none position-absolute border_blue menu_width" style="background-color: white;transform: translateY(-20px);right: 0;transform: translate(-50%, -50px);padding:0;">
                            <a asp-action="EditPost" asp-controller="Post" asp-route-postId="@post.Id" class="p-2 border_bottom_dark m-0 d-block">Редактировать</a>
                            <a asp-action="DeletePost" asp-controller="Post" asp-route-postId="@post.Id" class="p-2 border_bottom_dark m-0 d-block">Удалить</a>
                        </div>

                    }
                </div>
            </div>
        }
        @if (Model.Posts.Length == 5)
        {
            <p><button class="button form-control-plaintext w-25 m-auto mt-4" id="button_addnewstag">Загрузить ещё</button></p>
        }

    </div>
}

<script>
    $(document).ready(function () {
        var email = "";
        var userId = '@Model.UserId.ToString()';
        let take = 5;
        let skip = 0;
        $("#button_addnewstag").click(function () {
            take += 5;
            skip += 5;

            $.ajax({
                url: '/PostsMore/' + take + '/' + skip,
                type: 'POST',
                success: function (data) {
                    console.log(data);
                    for (var i = 0; i < data.length; i++) {
                        var opt = "";
                        var tags = "";

                        if (data[i].tags != null) {
                            for (var j = 0; j < data[i].tags.length; j++) {
                                tags += `<span class="bg_blue p-2 m-2" >` + data[i].tags[j].name + `</span>`;
                            }
                        }

                        if (data[i].user.id == userId) {
                            opt += `<span style="cursor:pointer;font-size: 25px;" class="col-xl-6 col-xxl-8 col-lg-4 col-md-8 col-sm-4 col-sm-4 col-2 color-blue text-end"  onclick="abilityPost(this)">…</span><div class="div_ability_post d-none position-absolute border_blue menu_width" style="background-color: white;transform: translateY(-20px);right: 0;transform: translate(-50%, -50px);padding:0;"><a href="/EditPost?postId=` + data[i].id + `" class="p-2 border_bottom_dark m-0 d-block">Редактировать</a><a href="/DeletePost?postId=` + data[i].id + `" class="p-2 border_bottom_dark m-0 d-block">Удалить</a></div>`;
                        }

                        var like = "";
                        if (userId != null) {
                            var k = false;
                            for (var j = 0; j < data[i].likes.length; j++) {
                                if (data[i].likes[j].userId == userId) {
                                    k = true;
                                }
                            }
                            if (k) {
                               like += `<svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="cursor:pointer;" onclick="like_post('` + data[i].id + `', this)"><path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill="#F8312F" /></svg>`;
                            }
                            else {
                               like += `<svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="cursor:pointer;" onclick="like_post('` + data[i].id + `', this)"><path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill="#CDE7FF" /></svg>`;                            }

                        }
                        else {
                            like = `<svg width="20" height = "19" viewBox = "0 0 20 19" fill = "none" xmlns = "http://www.w3.org/2000/svg" ><path d="M10 18.35L8.55 17.03C3.4 12.36 0 9.27 0 5.5C0 2.41 2.42 0 5.5 0C7.24 0 8.91 0.81 10 2.08C11.09 0.81 12.76 0 14.5 0C17.58 0 20 2.41 20 5.5C20 9.27 16.6 12.36 11.45 17.03L10 18.35Z" fill = "#CDE7FF" /></svg>`;
                        }

                        $("#posts_div").append(`<div class="mb-3 mt-5 posts"><p class="title">` + data[i].title + `</p><p class="color-blue">` + data[i].createdDate + `</p><div class="mt-2 posts_content">` + data[i].content + `</div><p>` + tags + `</p><div class="row align-items-center mt-5"><span class="col-xl-3 col-xxl-2 col-lg-4 col-md-2 col-sm-4 col-sm-4 col-5"><span>` + data[i].likes.length + `  </span>` + like + `</span><span class="col-xl-3 col-xxl-2 col-lg-4 col-md-2 col-sm-4 col-sm-4 col-5"><span> ` + data[i].comments.length + ` </span><a href="/LookingPost?postId=` + data[i].id + `"><svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.3 18.3L16 16H2C1.45 16 0.979333 15.8043 0.588 15.413C0.196 15.021 0 14.55 0 14V2C0 1.45 0.196 0.979 0.588 0.587C0.979333 0.195667 1.45 0 2 0H18C18.55 0 19.021 0.195667 19.413 0.587C19.8043 0.979 20 1.45 20 2V17.575C20 18.025 19.796 18.3373 19.388 18.512C18.9793 18.6873 18.6167 18.6167 18.3 18.3Z" fill="#CDE7FF" /></svg></a></span>` + opt + `</div></div>`);
                    };
                    if (data.length < 5) {
                        $("#button_addnewstag").addClass('d-none');
                    }
                }
            });



        });



    });
</script>
